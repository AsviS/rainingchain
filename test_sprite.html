<canvas id="ctx" width="500" height="300" style="border:1px solid #000000;"></canvas>
<br>
<input type="file" class="upload" onchange="readFiles(this.files)" multiple="" />
<br>
<input type="button" value="Test" onclick="Test()"><br>

<div id="anim"></div>

x <input type="number" id="x" value="250"/><br>
y <input type="number" id="y" value="150"/><br>
angle <input type="number" id="angle" value="90"/><br>
spd <input type="number" id="spd" value="1"/><br>
sizeMod <input type="number" id="sizeMod" value="1"/><br>

<script>
/* Sprite */
  
var ctx = document.getElementById("ctx").getContext("2d"); 
ctx.font = '30px Arial';

setInterval(function(){
	ctx.clearRect(0,0,1000,1000);
	for(var i in List.all){
		if(List.all[i].sprite)
			Sprite.loop(List.all[i]);
	}
},25);

Db = {sprite:{}};
List = {all:{
	bob:{
		x:150,
		y:150,
		angle:90,
		spdX:0,
		spdY:0,
		maxSpd:15,
		sprite:null,
	}
}};
player = List.all.bob;



Sprite = {};
Sprite.loop = function (mort){
	var spriteFromDb = Db.sprite[mort.sprite.name];
	
	/*
	if(mort.sprite.animOld !== mort.sprite.anim){	//otherwise, animation can be cut if timer for walk is high 
		mort.sprite.animOld = mort.sprite.anim;
		Sprite.change(mort,{'anim':mort.sprite.anim});
	}
	*/
	var animFromDb = spriteFromDb.anim[mort.sprite.anim];
	

	var mod = 1;
	if(animFromDb.walk){    //if walking, the speed of animation depends on movement speed
		var spd =  Math.max(Math.abs(mort.spdX),Math.abs(mort.spdY));
		mod = Math.abs(spd/mort.maxSpd);
	}
	
	mort.sprite.timer += animFromDb.spd * mod;	
	if(!mort.sprite.timer){mort.sprite.timer = 0;}
	mort.sprite.startX = Math.floor(mort.sprite.timer);
	
	if(mort.sprite.startX > animFromDb.frame-1){
		Sprite.change(mort,{'anim':animFromDb.next});
	}
		
	Draw.sprite(mort);
}

Sprite.change = function(mort,info){
	if(!mort || !mort.sprite) return;

	if(info.initAnim || info.anim){ 
		mort.sprite.initAnim = info.initAnim || mort.sprite.initAnim;
		mort.sprite.anim = info.initAnim || info.anim;
		
		mort.sprite.startX = 0;
		mort.sprite.spdBoost = 1;
		mort.sprite.timer = 0;
	}
	mort.sprite.name = info.name || mort.sprite.name || 'mace';
	mort.sprite.sizeMod = info.sizeMod || mort.sprite.sizeMod || 1;
	
	if(info.sizeMod || info.name) Sprite.updateBumper(mort);
}

Sprite.updateBumper = function(player){		//server only
	//Set the Sprite Bumper Box to fit the sizeMod
	if(Db.sprite[player.sprite.name].hitBox){	//Attack Dont
		player.hitBox = JSON.parse(JSON.stringify(Db.sprite[player.sprite.name].hitBox));
		player.bumperBox = JSON.parse(JSON.stringify(Db.sprite[player.sprite.name].bumperBox));	
		
		for(var i = 0 ; i < player.hitBox.length ; i++){
			player.hitBox[i].x *= player.sprite.sizeMod;
			player.hitBox[i].y *= player.sprite.sizeMod;
			player.bumperBox[i].x *= player.sprite.sizeMod;
			player.bumperBox[i].y *= player.sprite.sizeMod;	
		}	
	}
}
	

Sprite.creation = function(player,info){
	if(!info.anim) info.anim = Db.sprite[info.name || 'mace'].defaultAnim;
	info.oldAnim = info.anim;
	info.initAnim = info.anim;
	
	var a = Sprite.template();
	for(var i in info) a[i] = JSON.parse(JSON.stringify(info[i]));
	player.sprite = a;
	Sprite.updateBumper(player);
}
Sprite.template = function(){
	return {
    	name:'mace',
		initAnim:'walk',			//info about anim sent to client when init. use when anim is constant (ex: switch off)
    	anim:'walk',				//normally null. change for 1 frame when attack etc... changing initAnim will also change anim
    	sizeMod : 1,
    	oldAnim:'walk',				//client stuff
		startX : 0,
    	spdBoost : 1,
    	timer : 0,
    	walk : 0,
		alpha: 1,
		dead: 0,
	}
}
	
	
Draw = {};
Draw.sprite = function (mort){
	var spriteServer = mort.sprite;
	var spriteFromDb = Db.sprite[spriteServer.name];
	var image = spriteFromDb.img;
	var animFromDb = spriteFromDb.anim[spriteServer.anim];
	
	var sideAngle = Math.round(mort.angle/(360/animFromDb.dir)) % animFromDb.dir;
	
	var startX = spriteServer.startX * animFromDb.sizeX;
	var startY = animFromDb.startY + spriteFromDb.side[sideAngle] * animFromDb.sizeY;
	
	var sizeMod = spriteFromDb.size * spriteServer.sizeMod;
	
	ctx.drawImage(image, 
		startX,
		startY,
		animFromDb.sizeX,
		animFromDb.sizeY,
		-animFromDb.sizeX/2*sizeMod + mort.x,
		-animFromDb.sizeY/2*sizeMod + mort.y,
		animFromDb.sizeX * sizeMod,
		animFromDb.sizeY * sizeMod
	);
}
	
readFiles = function(files) {
	for (var i in files) { //for multiple files          
		(function(file) {
			var reader = new FileReader();  
			
			reader.fileName = file.name;
			if(file.type === "image/png"){
				reader.onload = readFiles.image;
				reader.readAsDataURL(file, "UTF-8");
			}
			if(file.type === "text/plain" || file.type === "application/javascript"){
				reader.onload = readFiles.script;
				reader.readAsText(file, "UTF-8");
			}
		})(files[i]);
	}
}

readFiles.image = function(e) {  
	var name = this.fileName.slice(0,this.fileName.indexOf('.'));
	loadedImage = new Image();
	loadedImage.src = this.result;
	loadedImage.id = name;
}


readFiles.script = function(e) {  
	var name = this.fileName.slice(0,this.fileName.indexOf('.'));
	var content = JSON.parse(e.target.result); 
	
	if(name === 'code'){
		Db.sprite[content.id] = content;
		init(Db.sprite[content.id]);
		Test();
	}
}


init = function(spr){
	/*
	if(spr.rgpvx){
		var src = spr.src;
		spr = {"size":2,"side":[2,0,1,3],'hpBar':-22,'legs':16,
		"preHitBox":[ -16,16,-16,16 ],"preBumperBox":[ -16,16,-16,16 ],
		"anim": {
			"walk":{"startY":0,"frame":3,"sizeX":32,"sizeY":32,"dir":4,"spd":0.5,'walk':1,"next":"walk"},
			"attack":{"startY":0,"frame":3,"sizeX":32,"sizeY":32,"dir":4,"spd":0.5,"next":"attack"},
		}};
		spr.src = src;
		Db.sprite[i] = spr;
	}
	*/
		
	spr.defaultAnim = spr.defaultAnim || Object.keys(spr.anim)[0];
	spr.size = spr.size || 1;
	spr.legs = spr.legs || 0;
	
	if(spr.preBumperBox) spr.preHitBox = spr.preHitBox || deepClone(spr.preBumperBox);
	
	for(var j in spr.anim){
		var anim = spr.anim[j];
		anim.startY = anim.startY || 0; 
		anim.spd = anim.spd || 1; 
		anim.next = anim.next || 'walk';
	}
		
    

	var sp = spr;
	sp.sizeMod = 1;
	if(sp.preBumperBox){			
		sp.bumperBox = [];
		sp.bumperBox[0] = { "x":sp.preBumperBox[1]*sp.size,"y":(sp.preBumperBox[2]+sp.preBumperBox[3])/2*sp.size };
		sp.bumperBox[1] = { "x":(sp.preBumperBox[0]+sp.preBumperBox[1])/2*sp.size,"y":sp.preBumperBox[3]*sp.size };
		sp.bumperBox[2] = { "x":sp.preBumperBox[0]*sp.size,"y":(sp.preBumperBox[2]+sp.preBumperBox[3])/2*sp.size };
		sp.bumperBox[3] = { "x":(sp.preBumperBox[0]+sp.preBumperBox[1])/2*sp.size,"y":sp.preBumperBox[2]*sp.size };
	}
	if(sp.preHitBox){
		sp.hitBox = []; 
		sp.hitBox[0] = { "x":sp.preHitBox[1]*sp.size,"y":(sp.preHitBox[2]-sp.preHitBox[3])/2*sp.size };
		sp.hitBox[1] = { "x":(sp.preHitBox[0]-sp.preHitBox[1])/2*sp.size,"y":sp.preHitBox[3]*sp.size };
		sp.hitBox[2] = { "x":sp.preHitBox[0]*sp.size,"y":(sp.preHitBox[2]-sp.preHitBox[3])/2*sp.size };
		sp.hitBox[3] = { "x":(sp.preHitBox[0]-sp.preHitBox[1])/2*sp.size,"y":sp.preHitBox[2]*sp.size };
	}
		
   
	sp.src = loadedImage;
	sp.img = loadedImage;
	sp.name = loadedImage.id;
}

Test = function(){
	player.x = +document.getElementById('x').value;
	player.y = +document.getElementById('y').value;
	player.spdX = +document.getElementById('spd').value;
	player.angle = +document.getElementById('angle').value;
	
	
	Sprite.creation(player,{
		name:loadedImage.id,
		sizeMod:+document.getElementById('sizeMod').value,
		anim:"walk"
	});

}


</script>




