
/*
0 - dont have
1 - have
2 - start with
3 - highway
4 - block

*/

Init.db.passive = function(){	
	Db.passive = [
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],'balancedAtk',2,2,2,2,['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],2,2,2,2,['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],2,2,2,2,['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],2,2,2,2,['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
	];
	
	//by default, each stat has a 100 count.
	for(var i = 0 ; i < Db.passive.length ; i++){
		for(var j = 0 ; j < Db.passive[i].length ; j++){
			var pg = Db.passive[i][j];
			if(typeof pg === 'object'){
				//stat random atm
				Db.passive[i][j] = {'stat':Passive.init.randomStat(),'value':pg[1],'count':100};
			}
			if(typeof pg === 'string'){
				pg = {'type':'custom','value':pg,'count':100};
			}
		}
	}
	
	//increase count depending on player popularity
	db.main.find({},{_id:0,passive:1},function(err,info){ if(err) throw err;
		for(var i = 0 ; i < info.length ; i++){
			for(var j = 0 ; j < info[i].passive.length ; j++){
				for(var k = 0 ; k < info[i].passive[j].length ; k++){
					if(info[i].passive[j][k] == '1'){
						Db.passive[j][k].count++;
					}
				}
			}
		}
		Db.passive = Passive.init(Db.passive);
		Db.passive = Passive.init.value(Db.passive);
	});


}






Passive = {};

//convert the list of passive owned by player into actual boost.
Passive.convert = function(p){
	var temp = [];
	for(var i = 0 ; i < Db.passive.length ; i++){
		for(var j = 0 ; j < Db.passive[i].length ; j++){
			if(p[i][j] == '1' && typeof Db.passive[i][j] === 'object'){
				if(Db.passive[i][j].stat){
					temp.push({'type':'base','value':Db.passive[i][j].value,'stat':Db.passive[i][j].stat});
				}
				if(Db.passive[i][j].type === 'custom'){
					temp.push({'type':'custom','value':Db.passive[i][j].value});
				}
			}
		}
	}
	temp = Actor.permBoost.compile(temp);
	return temp;
}





Passive.init = function(pg){
	//probably here cuz attribute to array are lost
	pg.min = findMin(pg,function(a){ return findMin(a,function(b){ return b.count || 1/0; })});  
	pg.max = findMax(pg,function(a){ return findMax(a,function(b){ return b.count || -1/0; })});  
	pg.sum = 0;		//total amount of passive pts spent
	pg.option = 0;	//amount of different options
	for(var i = 0 ; i < pg.length ; i++){
		for(var j = 0 ; j < pg[i].length ; j++){
			if(typeof pg[i][j] === 'object'){
				pg.sum += pg[i][j].count;
				pg.option++;
			}	
		}
	}
	pg.average = pg.sum / pg.option;
	return pg;
}

Passive.init.value = function(pg){
	for(var i = 0 ; i < pg.length ; i++){
		for(var j = 0 ; j < pg[i].length ; j++){
			if(pg[i][j].stat){
				pg[i][j].value *= pg.average / pg[i][j].count;
			}
		}
	}
	return pg;
}

Passive.init.randomStat = function(){
	var array = Object.keys(Db.stat);
	return array[Math.floor(Math.random()*array.length)]
}

Passive.template = function(){ 
	return [
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000222200000000',
		'00000000222200000000',
		'00000000222200000000',
		'00000000222200000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
	];
}




//test if player can choose a certain passive
Passive.test = function(passive,i,j){
	var n = [Math.max(0,i-1),j];
	var s = [Math.min(Db.passive.length-1,i+1),j];
	var w = [i,Math.max(0,j-1)];
	var e = [i,Math.min(Db.passive[i].length-1,j+1)];
	var pos = [n,s,w,e];
	
	for(var i in pos){
		var p = passive[pos[i][0]][pos[i][1]];
		if(p === '1' || p === '2'){
			return true;
		}
	}
	return false;	
}





























































