
/*
0 - dont have
1 - have
2 - start with
3 - highway
4 - block

*/

Init.db.passive = function(){	
	Db.passive = [
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],'balancedAtk',2,2,2,2,['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],2,2,2,2,['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],2,2,2,2,['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],2,2,2,2,['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
		[['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1],['maxSpd',1]],
	];
	
	//by default, each stat has a 100 count.
	for(var i = 0 ; i < Db.passive.length ; i++){
		for(var j = 0 ; j < Db.passive[i].length ; j++){
			var pg = Db.passive[i][j];
			if(typeof pg === 'object'){	//aka stat
				//stat random atm
				Db.passive[i][j] = {'stat':Passive.init.randomStat(),'value':pg[1],'count':100};
			}
			if(typeof pg === 'string'){	//aka custom
				pg = {'type':'custom','value':pg,'count':100};
			}
		}
	}
	
	//increase count depending on player popularity
	db.find('main',{},{_id:0,passive:1},function(err,info){ if(err) throw err;
		for(var i = 0 ; i < info.length ; i++){
			var main = info[i];
			for(var m in main.passive){
				var pass = main.passive[m];
				for(var j = 0 ; j < pass.length ; j++){
					for(var k = 0 ; k < pass[j].length ; k++){
						if(pass[j][k] == '1'){
							Db.passive[j][k].count++;
						}
					}
				}
			}
		}
		Db.passive = Passive.init(Db.passive);
		Db.passive = Passive.init.value(Db.passive);
	});


}


Passive = {};
Passive.updatePt = function(key){
	var main = List.main[key];
	for(var i in main.passive){
		main.passiveUsedPt[i] = Passive.getUsedPt(main.passive[i]);
	}
	main.passiveUsablePt = Passive.getUsablePt(key);
}

Passive.getUnusedPt = function(key,num){
	num = num || List.main[key].passiveActive;
	var p = List.main[key].passive[num];
	return Passive.getUsablePt(key)-Passive.getUsedPt(p);
}

Passive.getUsedPt = function(p){
	var used = 0;
	for(var i in p)
		for(var j = 0; j < p[i].length;j++)
			if(p[i][j] === '1') used++;
	return used;
}

Passive.getUsablePt = function(key){
	var total = Math.floor(Skill.getTotalLvl(key)/5);
	return total;
}


Passive.stack = function(p){
	//convert the list of passive owned by player into actual boost.
	var temp = [];
	for(var i = 0 ; i < Db.passive.length ; i++){
		for(var j = 0 ; j < Db.passive[i].length ; j++){
			if(p[i][j] == '1' && typeof Db.passive[i][j] === 'object'){
				if(Db.passive[i][j].stat){
					temp.push({'type':'base','value':Db.passive[i][j].value,'stat':Db.passive[i][j].stat});
				}
				if(Db.passive[i][j].type === 'custom'){
					temp.push({'type':'custom','value':Db.passive[i][j].value});
				}
			}
		}
	}
	temp = Actor.permBoost.stack(temp);
	return temp;
}





Passive.init = function(pg){
	//probably here cuz attribute to array are lost
	pg.min = findMin(pg,function(a){ return findMin(a,function(b){ return b.count || 1/0; })});  
	pg.max = findMax(pg,function(a){ return findMax(a,function(b){ return b.count || -1/0; })});  
	pg.sum = 0;		//total amount of passive pts spent
	pg.option = 0;	//amount of different options
	for(var i = 0 ; i < pg.length ; i++){
		for(var j = 0 ; j < pg[i].length ; j++){
			if(typeof pg[i][j] === 'object'){
				pg.sum += pg[i][j].count;
				pg.option++;
			}	
		}
	}
	pg.average = pg.sum / pg.option;
	return pg;
}

Passive.init.value = function(pg){
	for(var i = 0 ; i < pg.length ; i++){
		for(var j = 0 ; j < pg[i].length ; j++){
			if(pg[i][j].stat){
				pg[i][j].value *= pg.average / pg[i][j].count;
			}
		}
	}
	return pg;
}

Passive.init.randomStat = function(){
	var array = Object.keys(Db.stat);
	return array.random();
}

Passive.template = function(){ 
	return [
	[
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000222200000000',
		'00000000222200000000',
		'00000000222200000000',
		'00000000222200000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
	],
	[
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000222200000000',
		'00000000222200000000',
		'00000000222200000000',
		'00000000222200000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
		'00000000000000000000',
	]
	];
}

Passive.updateBoost = function(key){
	Actor.permBoost(List.all[key],'Passive',Passive.stack(List.main[key].passive[List.main[key].passiveActive]));
}		


//test if player can choose a certain passive
Passive.test = {};
Passive.test.add = function(passive,i,j){
	var n = [Math.max(0,i-1),j];
	var s = [Math.min(Db.passive.length-1,i+1),j];
	var w = [i,Math.max(0,j-1)];
	var e = [i,Math.min(Db.passive[i].length-1,j+1)];
	var pos = [n,s,w,e];
	
	for(var i in pos){
		var p = passive[pos[i][0]][pos[i][1]];
		if(p === '1' || p === '2'){
			return true;
		}
	}
	return false;	
}

Passive.test.remove = function(passive,yy,xx){
	if(passive[yy][xx] === '2') return false;

	var pass = deepClone(passive);
	pass[yy] = pass[yy].set(xx,'0');
	
	var listValid = {};
	var listTested = {};	//list where i already checked the pts around and added they to listValid
	var listToTest = {'8-8':1};
	var listNeedToBeValid = {};
	
	for(var i =0; i < pass.length; i++)
		for(var j =0; j < pass[i].length; j++)
			if(pass[i][j] !== '0')
				listNeedToBeValid[i+'-'+j] = 1;
	

	while(Object.keys(listToTest).length){
		for(var i in listToTest){
			var y = +i.slice(0,i.indexOf('-'));
			var x = +i.slice(i.indexOf('-')+1);
			
			var n = [Math.max(0,y-1),x];
			var s = [Math.min(Db.passive.length-1,y+1),x];
			var w = [y,Math.max(0,x-1)];
			var e = [y,Math.min(Db.passive[y].length-1,x+1)];
			
			var pos = [n,s,w,e];
			
			for(var k in pos){
				var p = pass[pos[k][0]][pos[k][1]];	
				var str = pos[k][0] + '-' + pos[k][1];
				if(p === '1' || p === '2'){
					if(!listTested[str])	listToTest[str] = 1;
				}
				listValid[str] = 1;
			}
			
			listTested[i] = 1;
			delete listToTest[i];
		}
	}	
	
	for(var i in listValid){
		delete listNeedToBeValid[i];
	}
	return !Object.keys(listNeedToBeValid).length
	
	
}




























































